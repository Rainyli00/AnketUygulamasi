<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <title>Anket Yönetimi - Admin</title>
  <link rel="icon" type="image/svg+xml" href="/favicon.svg">
  <link rel="icon" type="image/png" href="/favicon.ico">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f0f2f5;
      margin: 0;
    }

    .sidebar {
      height: 100vh;
      background: linear-gradient(180deg, #1f2937 0%, #111827 100%);
      color: #fff;
      padding: 1rem;
      min-width: 220px;
      box-shadow: 2px 0 8px rgba(0,0,0,0.2);
    }

    .sidebar h3 {
      margin-bottom: 2rem;
      text-align: center;
      color: #fbbf24;
      text-shadow: 1px 1px 3px rgba(0,0,0,0.4);
    }

    .sidebar a {
      color: #fff;
      display: block;
      margin: 1rem 0;
      text-decoration: none;
      padding: 0.5rem 1rem;
      border-radius: 8px;
      transition: 0.3s;
    }

    .sidebar a:hover, .sidebar a.active {
      background: #fbbf24;
      color: #111827;
      font-weight: 600;
      transform: translateX(5px);
    }

    .main {
      padding: 2rem;
      flex-grow: 1;
    }

    .anket-card {
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      border: none;
      background: white;
      margin-bottom: 1rem;
      overflow: hidden;
    }

    .anket-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 1rem;
    }

    .btn-action {
      margin: 0 0.2rem;
      padding: 0.4rem 0.8rem;
      border-radius: 6px;
      border: none;
      transition: 0.3s;
    }

    .btn-edit { background: #17a2b8; color: white; }
    .btn-edit:hover { background: #138496; }
    
    .btn-delete { background: #dc3545; color: white; }
    .btn-delete:hover { background: #c82333; }

    .alert-custom {
      border-radius: 8px;
      border: none;
    }
  </style>
</head>
<body>
  <div class="d-flex">
    
    <div class="sidebar">
      <h3>Admin Panel</h3>
      <a href="/admin">
        <i class="fas fa-tachometer-alt"></i> Dashboard
      </a>
      <a href="/admin/anketler" class="active">
        <i class="fas fa-poll"></i> Anketler
      </a>
      <a href="/admin/kullaniciCevap">
        <i class="fas fa-users"></i> Kullanıcılar
      </a>
      <a href="/admin/anketIstatistik">
        <i class="fas fa-chart-bar"></i> İstatistik
      </a>
      <hr style="margin: 2rem 0; border-color: #374151;">
      <a href="/admin/cikis" style="color: #ef4444;">
        <i class="fas fa-sign-out-alt" style="margin-right: 8px;"></i>Çıkış Yap
      </a>
    </div>

    
    <div class="main">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="fas fa-poll-h me-2"></i>Anket Yönetimi</h2>
        <a href="/admin/yeniAnket" class="btn btn-success">
          <i class="fas fa-plus me-2"></i>Yeni Anket Oluştur
        </a>
      </div>

      <!-- Mesajlar -->
      <% if (typeof req !== 'undefined' && req.query.basari) { %>
        <div class="alert alert-success alert-custom alert-dismissible fade show">
          <i class="fas fa-check-circle me-2"></i>
          <% if (req.query.basari === 'anket-olusturuldu') { %>
            Anket başarıyla oluşturuldu!
          <% } else if (req.query.basari === 'anket-silindi') { %>
            Anket başarıyla silindi!
          <% } else if (req.query.basari === 'anket-guncellendi') { %>
            Anket başarıyla güncellendi!
          <% } %>
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
      <% } %>

      <% if (typeof req !== 'undefined' && req.query.hata) { %>
        <div class="alert alert-danger alert-custom alert-dismissible fade show">
          <i class="fas fa-exclamation-triangle me-2"></i>
          <% if (req.query.hata === 'baslik-bos') { %>
            Anket başlığı boş olamaz!
          <% } else if (req.query.hata === 'veritabani') { %>
            Veritabanı hatası oluştu!
          <% } else if (req.query.hata === 'silme-hatasi') { %>
            Anket silinirken hata oluştu!
          <% } else if (req.query.hata === 'guncelleme-hatasi') { %>
            Anket güncellenirken hata oluştu!
          <% } %>
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
      <% } %>

      <!-- Filtre ve Arama kısmı -->
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="mb-0"><i class="fas fa-filter me-2"></i>Filtre ve Arama</h5>
        </div>
        <div class="card-body">
          <form method="GET" action="/admin/anketler" class="row g-3">
            <!-- Arama kısmı -->
            <div class="col-md-4">
              <label class="form-label">
                <i class="fas fa-search me-1"></i>Anket Başlığında Ara
              </label>
              <input type="text" name="arama" class="form-control" 
                     placeholder="Anket başlığı..." 
                     value="<%= typeof arama !== 'undefined' ? arama : '' %>">
            </div>
            
            
            <div class="col-md-3">
              <label class="form-label">
                <i class="fas fa-toggle-on me-1"></i>Durum
              </label>
              <select name="durum" class="form-select">
                <option value="tumu" <%= (typeof durum !== 'undefined' && durum === 'tumu') ? 'selected' : '' %>>
                  Tümü
                </option>
                <option value="aktif" <%= (typeof durum !== 'undefined' && durum === 'aktif') ? 'selected' : '' %>>
                  Aktif
                </option>
                <option value="pasif" <%= (typeof durum !== 'undefined' && durum === 'pasif') ? 'selected' : '' %>>
                  Pasif
                </option>
              </select>
            </div>
            
            <!-- Sıralama kısmı -->
            <div class="col-md-3">
              <label class="form-label">
                <i class="fas fa-sort me-1"></i>Sıralama
              </label>
              <select name="siralama" class="form-select">
                <option value="yeni" <%= (typeof siralama !== 'undefined' && siralama === 'yeni') ? 'selected' : '' %>>
                  En Yeni
                </option>
                <option value="eski" <%= (typeof siralama !== 'undefined' && siralama === 'eski') ? 'selected' : '' %>>
                  En Eski
                </option>
                <option value="alfabetik" <%= (typeof siralama !== 'undefined' && siralama === 'alfabetik') ? 'selected' : '' %>>
                  Alfabetik
                </option>
              </select>
            </div>
            
            <!-- Butonlar kısmı  -->
            <div class="col-md-2">
              <label class="form-label">&nbsp;</label>
              <div class="d-grid gap-2">
                <button type="submit" class="btn btn-primary">
                  <i class="fas fa-search me-1"></i>Filtrele
                </button>
                <a href="/admin/anketler" class="btn btn-outline-secondary btn-sm">
                  <i class="fas fa-times me-1"></i>Temizle
                </a>
              </div>
            </div>
          </form>
        </div>
      </div>

      <!-- Anket Listesi kısmı  -->
      <div class="row">
        <% if (anketler.length > 0) { %>
          <% anketler.forEach(anket => { %>
            <div class="col-md-6 col-lg-4 mb-3">
              <div class="anket-card">
                <div class="anket-header">
                  <div class="d-flex justify-content-between align-items-start">
                    <div>
                      <h5 class="mb-1"><%= anket.baslik %></h5>
                      <small>ID: #<%= anket.id %></small>
                      <% if (anket.olusturma_tarihi) { %>
                        <br><small class="text-light">
                          <i class="fas fa-calendar me-1"></i>
                          <%= new Date(anket.olusturma_tarihi).toLocaleDateString('tr-TR') %>
                        </small>
                      <% } %>
                    </div>
                    <span class="badge <%= anket.aktif ? 'bg-success' : 'bg-secondary' %>">
                      <i class="fas <%= anket.aktif ? 'fa-check-circle' : 'fa-pause-circle' %> me-1"></i>
                      <%= anket.aktif ? 'Aktif' : 'Pasif' %>
                    </span>
                  </div>
                </div>
                <div class="card-body p-3">
                  <div class="d-flex justify-content-between align-items-center">
                    <div>
                      <% if (anket.olusturma_tarihi) { %>
                        <small class="text-muted">
                          <i class="fas fa-clock me-1"></i>
                          <%= new Date(anket.olusturma_tarihi).toLocaleDateString('tr-TR') %> 
                          <%= new Date(anket.olusturma_tarihi).toLocaleTimeString('tr-TR', {hour: '2-digit', minute: '2-digit'}) %>
                        </small>
                      <% } else { %>
                        <small class="text-muted">Anket ID: <%= anket.id %></small>
                      <% } %>
                    </div>
                    <div>
                      <a href="/admin/anket/<%= anket.id %>" class="btn-action btn btn-primary text-white">
                        <i class="fas fa-cogs me-1"></i>Yönet
                      </a>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          <% }) %>
        <% } else { %>
          <div class="col-12">
            <div class="text-center py-5">
              <i class="fas fa-poll-h fa-5x text-muted mb-3"></i>
              <h4 class="text-muted">Henüz anket bulunmamaktadır.</h4>
              <p class="text-muted">İlk anketinizi oluşturmak için yukarıdaki butona tıklayın.</p>
            </div>
          </div>
        <% } %>
      </div>
      
      <!-- Sayfalama kısmı -->
      <% if (toplamSayfa > 1) { %>
        <%
          // Mevcut filtreleri koruyacak url oluşturma kısmı
          function sayfaURL(sayfaNo) {
            const params = new URLSearchParams();
            params.set('sayfa', sayfaNo);
            if (typeof arama !== 'undefined' && arama) params.set('arama', arama);
            if (typeof durum !== 'undefined' && durum !== 'tumu') params.set('durum', durum);
            if (typeof siralama !== 'undefined' && siralama !== 'yeni') params.set('siralama', siralama);
            return '/admin/anketler?' + params.toString();
          }
        %>
        <div class="row mt-4">
          <div class="col-12">
            <nav aria-label="Anket sayfaları">
              <ul class="pagination justify-content-center">
                <!-- İlk sayfa -->
                <% if (mevcutSayfa > 1) { %>
                  <li class="page-item">
                    <a class="page-link" href="<%= sayfaURL(1) %>" aria-label="İlk">
                      <span aria-hidden="true">&laquo;&laquo;</span>
                    </a>
                  </li>
                  <li class="page-item">
                    <a class="page-link" href="<%= sayfaURL(mevcutSayfa - 1) %>" aria-label="Önceki">
                      <span aria-hidden="true">&laquo;</span>
                    </a>
                  </li>
                <% } %>
                
                <!-- Sayfa numaraları -->
                <% 
                  let baslangic = Math.max(1, mevcutSayfa - 2);
                  let bitis = Math.min(toplamSayfa, mevcutSayfa + 2);
                %>
                
                <% for (let i = baslangic; i <= bitis; i++) { %>
                  <li class="page-item <%= mevcutSayfa === i ? 'active' : '' %>">
                    <a class="page-link" href="<%= sayfaURL(i) %>"><%= i %></a>
                  </li>
                <% } %>
                
                <!-- Son sayfa -->
                <% if (mevcutSayfa < toplamSayfa) { %>
                  <li class="page-item">
                    <a class="page-link" href="<%= sayfaURL(mevcutSayfa + 1) %>" aria-label="Sonraki">
                      <span aria-hidden="true">&raquo;</span>
                    </a>
                  </li>
                  <li class="page-item">
                    <a class="page-link" href="<%= sayfaURL(toplamSayfa) %>" aria-label="Son">
                      <span aria-hidden="true">&raquo;&raquo;</span>
                    </a>
                  </li>
                <% } %>
              </ul>
            </nav>
            
            <!-- Sayfa bilgisi kısmı -->
            <div class="text-center mt-3">
              <small class="text-muted">
                <i class="fas fa-info-circle me-1"></i>
                Toplam <%= toplamAnket %> anket, 
                Sayfa <%= mevcutSayfa %> / <%= toplamSayfa %> 
              </small>
            </div>
          </div>
        </div>
      <% } %>
    </div>
  </div>

  <!-- copyright -->
  <div style="text-align: center; padding: 15px; margin-top: 20px;">
    <div style="display: inline-block; background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); padding: 8px 16px; border-radius: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); border: 1px solid rgba(0,0,0,0.05);">
      <p style="margin: 0; color: #6c757d; font-size: 11px; font-weight: 500;">
        © 2025 Mehmet Emin Fındıkçı
      </p>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
