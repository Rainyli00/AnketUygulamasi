<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Anket - <%= anket.baslik %></title>
  <link rel="icon" type="image/svg+xml" href="/favicon.svg">
  <link rel="icon" type="image/png" href="/favicon.ico">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f1f5f9;
      min-height: 100vh;
      margin: 0;
    }

    .main-container {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.1);
      margin: 2rem auto;
      max-width: 900px;
      overflow: hidden;
    }

    .header-section {
      background: linear-gradient(135deg, #1f2937 0%, #111827 100%);
      color: white;
      padding: 2rem;
      text-align: center;
    }

    .header-section h1 {
      font-size: 2rem;
      margin-bottom: 0.5rem;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }

    .header-section .date-info {
      font-size: 0.9rem;
      opacity: 0.8;
      margin: 0;
    }

    .form-section {
      padding: 2rem;
    }

    .user-info-card {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
      border: none;
      border-radius: 15px;
      margin-bottom: 2rem;
      box-shadow: 0 8px 25px rgba(16, 185, 129, 0.2);
    }

    .user-info-card .card-body {
      padding: 1.5rem;
    }

    .user-info-card .form-control {
      border: 2px solid rgba(255,255,255,0.3);
      border-radius: 10px;
      background: rgba(255,255,255,0.1);
      color: white;
      padding: 0.75rem 1rem;
    }

    .user-info-card .form-control::placeholder {
      color: rgba(255,255,255,0.7);
    }

    .user-info-card .form-control:focus {
      border-color: rgba(255,255,255,0.8);
      background: rgba(255,255,255,0.2);
      box-shadow: 0 0 0 3px rgba(255,255,255,0.1);
    }

    .soru-card {
      border: none;
      border-radius: 15px;
      box-shadow: 0 8px 25px rgba(0,0,0,0.1);
      margin-bottom: 2rem;
      overflow: hidden;
      transition: all 0.3s ease;
    }

    .soru-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 30px rgba(0,0,0,0.15);
    }

    .soru-header {
      background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
      color: white;
      padding: 1.5rem;
    }

    .soru-title {
      font-size: 1.1rem;
      font-weight: 600;
      margin: 0;
    }

    .soru-body {
      padding: 1.5rem;
      background: white;
    }

    .form-check {
      margin-bottom: 1rem;
      padding: 0.75rem;
      border-radius: 10px;
      transition: all 0.3s ease;
    }

    .form-check:hover {
      background: #f8fafc;
    }

    .form-check-input:checked + .form-check-label {
      color: #1d4ed8;
      font-weight: 600;
    }

    .form-check-input {
      width: 1.2rem;
      height: 1.2rem;
      margin-top: 0.1rem;
    }

    .form-check-label {
      font-size: 1rem;
      margin-left: 0.5rem;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .diger-input {
      border: 2px solid #e5e7eb;
      border-radius: 10px;
      padding: 0.75rem 1rem;
      margin-top: 0.5rem;
      transition: all 0.3s ease;
    }

    .diger-input:focus {
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .btn-submit {
      background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
      border: none;
      padding: 1rem 2rem;
      border-radius: 15px;
      color: white;
      font-weight: 600;
      font-size: 1.1rem;
      width: 100%;
      transition: all 0.3s ease;
      box-shadow: 0 8px 25px rgba(220, 38, 38, 0.3);
    }

    .btn-submit:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 30px rgba(220, 38, 38, 0.4);
      color: white;
    }

    .back-link {
      display: inline-block;
      color: white;
      text-decoration: none;
      font-weight: 500;
      transition: all 0.3s ease;
    }

    .back-link:hover {
      color: #fbbf24;
      text-decoration: none;
    }

    .progress-indicator {
      background: rgba(255,255,255,0.2);
      height: 4px;
      border-radius: 2px;
      margin-top: 1rem;
    }

    .progress-bar {
      background: #fbbf24;
      height: 100%;
      border-radius: 2px;
      transition: width 0.3s ease;
    }
  </style>
</head>
<body>

  <div class="main-container">
    <!-- Baş kısım -->
    <div class="header-section">
      <a href="/users" class="back-link">
        <i class="fas fa-arrow-left me-2"></i>Anket Listesine Dön
      </a>
      <h1 class="mt-3"><%= anket.baslik %></h1>
      <p class="date-info">
        <i class="fas fa-calendar me-1"></i>
        Oluşturulma Tarihi: <%= new Date(anket.olusturma_tarihi).toLocaleDateString('tr-TR') %>
      </p>
      <div class="progress-indicator">
        <div class="progress-bar" style="width: 0%" id="progressBar"></div>
      </div>
    </div>

    <!-- Form Kısmı -->
    <div class="form-section">
      <form action="/users/anket/<%= anket.id %>/cevapla" method="POST" id="anketForm">
        <!-- Kullanıcı Bilgi Kartı -->
        <div class="card user-info-card">
          <div class="card-body">
            <h5 class="mb-3">
              <i class="fas fa-user me-2"></i>Kişisel Bilgiler
            </h5>
            
            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="isim" class="form-label">Ad Soyad</label>
                <input type="text" class="form-control" id="isim" name="isim" 
                       placeholder="Adınızı ve soyadınızı yazın">
              </div>
              <div class="col-md-6 mb-3">
                <label for="email" class="form-label">E-posta</label>
                <input type="email" class="form-control" id="email" name="email" 
                       placeholder="ornek@email.com">
              </div>
            </div>
            
            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="telefon" class="form-label">Telefon</label>
                <input type="tel" class="form-control" id="telefon" name="telefon" 
                       placeholder="05XX XXX XX XX">
              </div>
              <div class="col-md-6 mb-3">
                <label for="tc_kimlik" class="form-label">TC Kimlik No</label>
                <input type="text" class="form-control" id="tc_kimlik" name="tc_kimlik" 
                       placeholder="XXXXXXXXXXX" maxlength="11">
              </div>
            </div>
            
            <small class="text-white-50 mt-2 d-block">
              <i class="fas fa-info-circle me-1"></i>
              Tüm bilgiler isteğe bağlıdır.
            </small>
          </div>
        </div>

        <!-- Sorular Kısmı -->
        <% sorular.forEach((soru, index) => { %>
          <div class="soru-card" data-soru-index="<%= index %>" data-zorunlu="<%= soru.zorunlu ? 'true' : 'false' %>">
            <div class="soru-header">
              <h5 class="soru-title">
                <span class="badge bg-white text-primary me-2"><%= index + 1 %></span>
                <%= soru.soru_metni %>
              </h5>
            </div>
            <div class="soru-body">
              <% secenekler[soru.id].forEach(secenek => { %>
                <div class="form-check">
                  <input class="form-check-input secenek-radio" type="radio" 
                         name="soru_<%= soru.id %>" 
                         value="<%= secenek.id %>" 
                         id="secenek_<%= secenek.id %>" 
                         data-diger="<%= secenek.secenek_metni === 'Diğer' ? 'true' : 'false' %>">
                  <label class="form-check-label" for="secenek_<%= secenek.id %>">
                    <% if (secenek.secenek_metni === 'Diğer') { %>
                      <i class="fas fa-edit me-1"></i><%= secenek.secenek_metni %>
                    <% } else { %>
                      <%= secenek.secenek_metni %>
                    <% } %>
                  </label>
                </div>
              <% }) %>
              
              <!-- Diğer seçeneği için text input (sadece Diğer seçeneği varsa görünür) -->
              <input type="text" class="form-control diger-input d-none" 
                     name="diger_<%= soru.id %>" placeholder="Lütfen açıklayınız...">
            </div>
          </div>
        <% }) %>

        <!-- Submit Butonu -->
        <div class="text-center">
          <button type="submit" class="btn btn-submit">
            <i class="fas fa-paper-plane me-2"></i>Cevapları Gönder
          </button>
          
        </div>
      </form>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Tüm radio butonları, soru kartları, progress bar ve formu seçer
    const radioButonlar = document.querySelectorAll('.secenek-radio');
    const soruKartlar = document.querySelectorAll('.soru-card');
    const ilerlemeCubugu = document.getElementById('progressBar');
    const anketFormu = document.getElementById('anketForm');

    // İlerleme çubuğunu günceller
    function ilerlemeGuncelle() {
      const toplamSoru = soruKartlar.length;
      let cevaplananSoru = 0;

      soruKartlar.forEach(kart => {
        const radioInputlar = kart.querySelectorAll('input[type="radio"]');
        const cevaplandiMi = Array.from(radioInputlar).some(input => input.checked);
        if (cevaplandiMi) cevaplananSoru++;
      });

      const ilerleme = (cevaplananSoru / toplamSoru) * 100;
      ilerlemeCubugu.style.width = ilerleme + '%';
    }

    // butonlara event ekler
    radioButonlar.forEach(radio => {
      radio.addEventListener('change', (e) => {
        const digerInput = e.target.closest('.soru-card').querySelector('.diger-input');
        
        if (e.target.dataset.diger === 'true') {
          digerInput.classList.remove('d-none');
          digerInput.focus();
        } else {
          digerInput.classList.add('d-none');
          digerInput.value = '';
        }
        
        // İlerleme çubuğunu günceller
        ilerlemeGuncelle();
        
        // Kartı vurgular
        const soruKart = e.target.closest('.soru-card');
        soruKart.style.borderLeft = '4px solid #10b981';
        setTimeout(() => {
          soruKart.style.borderLeft = 'none';
        }, 1000);
      });
    });

    // Form gönderimini kontrol eder
    anketFormu.addEventListener('submit', (e) => {
      let eksikZorunlu = false;
      let cevaplananSoru = 0;
      let eksikZorunluSorular = [];

      soruKartlar.forEach((kart, index) => {
        const zorunlu = kart.getAttribute('data-zorunlu') === 'true';
        const radioInputlar = kart.querySelectorAll('input[type="radio"]');
        const cevaplandiMi = Array.from(radioInputlar).some(input => input.checked);
        
        if (cevaplandiMi) cevaplananSoru++;
        
        if (zorunlu && !cevaplandiMi) {
          eksikZorunlu = true;
          eksikZorunluSorular.push(index + 1);
          // Eksik zorunlu soruyu vurgular
          kart.style.borderLeft = '4px solid #dc2626';
          kart.style.backgroundColor = '#fef2f2';
        } else {
          // Vurguyu kaldırır
          kart.style.borderLeft = 'none';
          kart.style.backgroundColor = '';
        }
      });

      if (eksikZorunlu) {
        e.preventDefault();
        Swal.fire({
          icon: 'warning',
          title: 'Zorunlu Soruyu Cevaplamadınız',
          text: `Lütfen ${eksikZorunluSorular.join(', ')}. soruyu cevaplayın.`,
          confirmButtonText: 'Tamam',
          confirmButtonColor: '#3085d6'
        });
        return;
      }

      if (cevaplananSoru === 0) {
        e.preventDefault();
        Swal.fire({
          icon: 'warning',
          title: 'Eksik Bilgi',
          text: 'Lütfen en az bir soruyu cevaplayın.',
          confirmButtonText: 'Tamam',
          confirmButtonColor: '#3085d6'
        });
        return;
      }

      // E-posta kontrolü (
      const emailInput = document.getElementById('email');
      if (emailInput.value.trim() && !emailGecerliMi(emailInput.value.trim())) {
        e.preventDefault();
        Swal.fire({
          icon: 'error',
          title: 'Geçersiz E-posta',
          text: 'Lütfen geçerli bir e-posta adresi girin.',
          confirmButtonText: 'Tamam',
          confirmButtonColor: '#3085d6'
        });
        emailInput.focus();
        return;
      }

      // TC kimlik kontrolü 
      const tcInput = document.getElementById('tc_kimlik');
      if (tcInput.value.trim() && !tcGecerliMi(tcInput.value.trim())) {
        e.preventDefault();
        Swal.fire({
          icon: 'error',
          title: 'Geçersiz TC Kimlik',
          text: 'TC kimlik numarası 11 haneli olmalıdır.',
          confirmButtonText: 'Tamam',
          confirmButtonColor: '#3085d6'
        });
        tcInput.focus();
        return;
      }

      // Telefon kontrolü
      const telefonInput = document.getElementById('telefon');
      if (telefonInput.value.trim() && !telefonGecerliMi(telefonInput.value.replace(/\s/g, ''))) {
        e.preventDefault();
        Swal.fire({
          icon: 'error',
          title: 'Geçersiz Telefon',
          text: 'Telefon numarası 05XXXXXXXXX formatında olmalıdır.',
          confirmButtonText: 'Tamam',
          confirmButtonColor: '#3085d6'
        });
        telefonInput.focus();
        return;
      }

      // Yükleniyor durumunu gösterir
      const gonderBtn = document.querySelector('.btn-submit');
      gonderBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Gönderiliyor...';
      gonderBtn.disabled = true;
    });

    // form inputları
    const emailInput = document.getElementById('email');
    const telefonInput = document.getElementById('telefon');
    const tcInput = document.getElementById('tc_kimlik');

    // E-posta kontrolü
    emailInput.addEventListener('blur', function() {
      const email = this.value.trim();
      if (email && !emailGecerliMi(email)) {
        this.style.borderColor = '#dc2626';
        tooltipGoster(this, 'Geçerli bir e-posta adresi girin');
      } else {
        this.style.borderColor = '';
        tooltipGizle(this);
      }
    });

    // Telefon kontrolü
    telefonInput.addEventListener('input', function() {
      // Sadece rakam ve boşluk girişine izin verir
      this.value = this.value.replace(/[^\d\s]/g, '');
    });

    telefonInput.addEventListener('blur', function() {
      const telefon = this.value.replace(/\s/g, '');
      if (telefon && !telefonGecerliMi(telefon)) {
        this.style.borderColor = '#dc2626';
        tooltipGoster(this, 'Geçerli bir telefon numarası girin (05XXXXXXXXX)');
      } else {
        this.style.borderColor = '';
        tooltipGizle(this);
      }
    });

    // TC Kimlik kontrolü
    tcInput.addEventListener('input', function() {
      // Sadece rakam girişine izin verir
      this.value = this.value.replace(/\D/g, '');
    });

    tcInput.addEventListener('blur', function() {
      const tc = this.value.trim();
      if (tc && !tcGecerliMi(tc)) {
        this.style.borderColor = '#dc2626';
        tooltipGoster(this, 'Geçerli bir TC kimlik numarası girin (11 haneli)');
      } else {
        this.style.borderColor = '';
        tooltipGizle(this);
      }
    });

    // Kontrol fonksiyonları
    function emailGecerliMi(email) {
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      return emailRegex.test(email);
    }

    function telefonGecerliMi(telefon) {
      const telefonRegex = /^05\d{9}$/;
      return telefonRegex.test(telefon);
    }

    function tcGecerliMi(tc) {
      //11 haneli rakam kontrolü yapılır
      if (!tc || tc.length !== 11) return false;
      
      // rakam olup olmadığı kontrol edilir.
      const rakamKontrol = /^\d{11}$/;
      return rakamKontrol.test(tc);
    }

    function tooltipGoster(element, mesaj) {
      // Mevcut tooltip'i kaldırır
      tooltipGizle(element);
      
      const tooltip = document.createElement('div');
      tooltip.className = 'validation-tooltip';
      tooltip.textContent = mesaj;
      tooltip.style.cssText = `
        position: absolute;
        background: #dc2626;
        color: white;
        padding: 0.5rem;
        border-radius: 5px;
        font-size: 0.8rem;
        z-index: 1000;
        margin-top: 5px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      `;
      
      element.parentNode.style.position = 'relative';
      element.parentNode.appendChild(tooltip);
    }

    function tooltipGizle(element) {
      const tooltip = element.parentNode.querySelector('.validation-tooltip');
      if (tooltip) {
        tooltip.remove();
      }
    }

    // Sayfa yüklendiğinde ilerleme çubuğunu günceller
    ilerlemeGuncelle();
  </script>

  <!-- copyright -->
  <div style="text-align: center; padding: 20px; margin-top: 30px;">
    <div style="display: inline-block; background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); padding: 8px 20px; border-radius: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); border: 1px solid rgba(0,0,0,0.05);">
      <p style="margin: 0; color: #6c757d; font-size: 12px; font-weight: 500;">
        © 2025 Mehmet Emin Fındıkçı
      </p>
    </div>
  </div>

</body>
</html>
